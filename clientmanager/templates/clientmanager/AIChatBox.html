<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Chat Box</title>
    <style>
        /* Base body styling - centers the chat container on the page */
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f7f9;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh; /* Full viewport height */
        }

        /* Main chat container - holds all chat elements */
        .chat-container {
            width: 500px;
            height: 700px;
            max-height: 700px;
            background-color: #fff;
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(0,0,0,0.1); /* Subtle shadow for depth */
            display: flex;
            flex-direction: column; /* Stack elements vertically */
            overflow: hidden; /* Prevent content from spilling out */
        }

        /* Chat header - shows the agent name/title */
        .chat-header {
            background-color: #2e3a59;
            color: #fff;
            padding: 15px;
            text-align: center;
            font-weight: bold;
        }

        /* Warning notice about API key setup */
        .api-key-notice {
            background-color: #fff3cd; /* Light yellow background */
            color: #856404; /* Dark yellow text */
            padding: 8px 15px;
            font-size: 12px;
            border-bottom: 1px solid #ffeaa7;
            text-align: center;
        }

        /* Main chat area where messages appear */
        .chat-body {
            flex: 1; /* Takes up remaining space */
            padding: 15px;
            overflow-y: auto; /* Scrollable when messages overflow */
            display: flex;
            flex-direction: column;
            gap: 10px; /* Space between messages */
        }

        /* Base styling for all messages */
        .message {
            max-width: 75%; /* Prevents messages from being too wide */
            padding: 10px 14px;
            border-radius: 20px; /* Rounded message bubbles */
            font-size: 14px;
            line-height: 1.4;
        }

        /* User message styling - appears on the right */
        .user {
            align-self: flex-end; /* Positions to the right */
            background-color: #daf0ff; /* Light blue background */
        }

        /* Agent message styling - appears on the left */
        .agent {
            align-self: flex-start; /* Positions to the left */
            background-color: #eeeeee; /* Light gray background */
        }

        /* Typing indicator when agent is responding */
        .typing-indicator {
            align-self: flex-start;
            background-color: #eeeeee;
            padding: 10px 14px;
            border-radius: 20px;
            font-size: 14px;
            color: #666;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Container for the animated typing dots */
        .typing-dots {
            display: flex;
            gap: 3px;
        }

        /* Individual animated dots */
        .dot {
            width: 6px;
            height: 6px;
            background-color: #999;
            border-radius: 50%;
            animation: typing 1.4s infinite; /* Bounce animation */
        }

        /* Stagger the animation for each dot */
        .dot:nth-child(1) { animation-delay: 0s; }
        .dot:nth-child(2) { animation-delay: 0.2s; }
        .dot:nth-child(3) { animation-delay: 0.4s; }

        /* Keyframes for the bouncing dot animation */
        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-4px); }
        }

        /* Error message styling */
        .error-message {
            align-self: flex-start;
            background-color: #f8d7da; /* Light red background */
            color: #721c24; /* Dark red text */
            padding: 10px 14px;
            border-radius: 20px;
            font-size: 14px;
            max-width: 75%;
        }

        /* Input area at the bottom of the chat */
        .chat-input {
            display: flex;
            padding: 10px;
            border-top: 1px solid #ddd;
            background-color: #fafafa;
        }

        /* Text input field styling */
        .chat-input input {
            flex: 1; /* Takes up most of the space */
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 20px;
            outline: none;
        }

        /* Input field focus state */
        .chat-input input:focus {
            border-color: #2e3a59;
        }

        /* Send button styling */
        .chat-input button {
            margin-left: 10px;
            padding: 10px 20px;
            background-color: #2e3a59;
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
        }

        /* Send button hover effect */
        .chat-input button:hover {
            background-color: #1c2740;
        }

        /* Disabled send button styling */
        .chat-input button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        /* Mobile responsiveness - adjusts layout for smaller screens */
        @media (max-width: 768px) {
            body {
                padding: 20px;
            }

            .chat-container {
                width: 500px;
                max-width: 99%; /* Fits smaller screens */
                height: 700px;
                max-height: 700px;
            }
        }
    </style>
</head>
<body>
	<!-- Main chat container structure -->
	<div class="chat-container">
	  <!-- Header showing agent name -->
	  <div class="chat-header">Support Agent</div>

	  <!-- Chat messages area -->
	  <div class="chat-body" id="chatBody">
		<div class="message agent">
		  Welcome! I have access to the complete Employee User Manual and can help you understand how to use our systems, navigate features, or find specific procedures. How can I assist you?
		</div>
	  </div>

	  <!-- Input area for user messages -->
	  <div class="chat-input">
		<input
		  type="text"
		  id="chatInput"
		  placeholder="Type your message…"
		  maxlength="500"
		/>
		<!-- IMPORTANT: add class="send-btn" and remove inline onclick -->
		<button class="send-btn">Send</button>
	  </div>
	</div>

<!-- script LAST so DOM elements exist -->
<!-- put this just before </body> -->
	<script>
		(() => {
		  /* ---------- DOM ---------- */
		  const chatBody  = document.getElementById('chatBody');
		  const chatInput = document.getElementById('chatInput');
		  const sendBtn   = document.querySelector('.send-btn');      // ← works now

		  /* ---------- State ---------- */
		  const conversationHistory = [
			{ role: 'system', content: 'You are a helpful CRM assistant.' }
		  ];

		  /* ---------- Helpers ---------- */
		  const getCookie = name =>
			document.cookie.split('; ')
			  .find(c => c.startsWith(name + '='))?.split('=')[1] || '';

		  function addMessage(role, text) {
			const div = document.createElement('div');
			div.className = `message ${role === 'user' ? 'user' : 'agent'}`;
			div.textContent = text;
			chatBody.appendChild(div);
			chatBody.scrollTop = chatBody.scrollHeight;
		  }

		  /* ---------- Core ---------- */
		  async function sendMessage() {
			const userMsg = chatInput.value.trim();
			if (!userMsg) return;

			addMessage('user', userMsg);
			chatInput.value = '';
			conversationHistory.push({ role: 'user', content: userMsg });

			try {
			  const rsp = await fetch('/chat-proxy/', {
				method: 'POST',
				headers: {
				  'Content-Type': 'application/json',
				  'X-CSRFToken': getCookie('csrftoken')
				},
				body: JSON.stringify({ messages: conversationHistory })
			  });

			  if (!rsp.ok) throw new Error('Server error');
			  const data  = await rsp.json();
			  const aiMsg = data.choices[0].message.content;

			  conversationHistory.push({ role: 'assistant', content: aiMsg });
			  addMessage('assistant', aiMsg);

			} catch (err) {
			  console.error(err);
			  addMessage('agent', '⚠️ Sorry, something went wrong.');
			}
		  }

		  /* ---------- Events ---------- */
		  sendBtn.addEventListener('click', sendMessage);
		  chatInput.addEventListener('keypress', e => {
			if (e.key === 'Enter' && !e.shiftKey) {
			  e.preventDefault();
			  sendMessage();
			}
		  });

		  chatInput.focus();
		})();
/*	
	(function(){
	  function getCookie(name){
		let v=null; if(!document.cookie) return v;
		for(let c of document.cookie.split(";")){
		  c=c.trim();
		  if(c.startsWith(name+"=")){ v=decodeURIComponent(c.slice(name.length+1)); break; }
		}
		return v;
	  }
	  function descriptorFor(el){
		if(!el) return "UNKNOWN";
		const t = el.closest?.('[data-track], a, button, [role="button"], input, textarea, select') || el;
		const tag = (t.tagName || "NODE").toUpperCase();
		const id = t.id ? `#${t.id}` : "";
		const cls = (t.className && typeof t.className === "string") ? "."+t.className.trim().split(/\s+/).join(".") : "";
		const label = t.getAttribute?.("aria-label") || t.getAttribute?.("title") || "";
		const text = (t.innerText || "").trim().slice(0,50);
		const name = t.getAttribute?.("name") || "";
		let extra = label || name || text;
		if (extra) extra = ` - "${extra}"`;
		return `${tag}${id}${cls}${extra}`;
	  }
	  function sendEvent(eventType, element, value, page, keepalive){
		const payload = {
		  username: getCookie("username") || "",
		  event_type: eventType,
		  element: element,
		  value: value,
		  page: page
		};
		fetch("/track-event/", {
		  method: "POST",
		  credentials: "same-origin",
		  keepalive: !!keepalive,
		  headers: {
			"Content-Type": "application/json",
			"X-CSRFToken": getCookie("csrftoken")
		  },
		  body: JSON.stringify(payload)
		}).catch(()=>{});
	  }

	  // clicks (capture early; use keepalive if navigating)
	  document.addEventListener("click", function(e){
		let target = e.target instanceof Element ? e.target : document.elementFromPoint(e.clientX, e.clientY);
		const desc = descriptorFor(target);
		const a = target?.closest && target.closest("a[href]");
		const willNav = !!a && a.getAttribute("href") && a.target !== "_blank" && !a.hasAttribute("download");
		sendEvent("click", desc, "", window.location.pathname, willNav);
	  }, true);

	  // typing
	  document.addEventListener("input", function(e){
		const el = e.target;
		if (el && (el.tagName === "INPUT" || el.tagName === "TEXTAREA")) {
		  sendEvent("input", descriptorFor(el), el.value || "", window.location.pathname, false);
		}
	  });

	  // optional pageview
	  document.addEventListener("DOMContentLoaded", function(){
		sendEvent("pageview", "DOCUMENT", "", window.location.pathname, false);
	  });
	})();*/
	</script>
</body>
</html>